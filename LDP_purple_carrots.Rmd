---
title: "Modification and Prototypicality in LDP"
author: "ben morris"
date: "6/28/2019"
output: html_document
---


```{r setup}
#set up and get SQL connection
library(RMySQL)
library(SnowballC)
library(childesr)
library(tidytext)
library(tictoc)
library(ggridges)
library(tidyverse)
library(here)
library(scales)
library(tidyboot)
library(lme4)

source(here("read_ldp.R"))
ldp <- connect_to_ldp()
```

```{r}
list_tables <- function(connection) {
  DBI::dbListTables(connection)
}

get_table <- function(connection, name) {
  dplyr::tbl(connection, name)
}

list_tables(ldp)
get_table(ldp, "ppvt")
```

```{r}
tic()
utts <- get_table(ldp, "utterances") %>%
  collect()
toc()
beep()

utts_clean <- utts %>%
  #grab parent utterances
  filter(!is.na(p_chat))  %>%
  #drop the many things we don't care about
  select(subject, session, p_chat, p_mor)  %>%
  #add new utt_id variable
  mutate(utt_id= row_number())

PoS <- utts_clean %>% 
  # filter(session==1) %>%
  unnest_tokens(PoS, p_mor, drop=FALSE, token = stringr::str_split, pattern = " ") %>%
  filter(PoS != "")
```


```{r}
  #unnest just morph codes --> PoS
  # then split morph code into morph + word (but ugly stem stuff, could be tricksome)
head(PoS)
tagged <- PoS %>%
  separate(PoS, into=c("PoS", "word"), sep="\\|") %>%
  filter(!is.na(word)) %>%
  separate(word, into=c("word", "garbage"), sep= "[^[:alnum:]]") %>%
  mutate(stem = wordStem(word)) %>%  
  select(-garbage)

tagged %>%
  mutate(stem = wordStem(word)) %>%  
  anti_join(stop_words) %>%
  filter(grepl("n:",PoS, fixed=TRUE) | 
           grepl("n|",PoS, fixed=TRUE) |
           grepl("n",PoS, fixed=TRUE)) %>%
  count(stem, sort=TRUE) %>% 
  head(100)

tagged %>%
  filter(PoS=="adj") %>%
  # filter(grepl("adj",PoS, fixed=TRUE)) %>%
  count(word, sort=TRUE) 
```


#check noun usage consistency across ages
#correlate rank frequency across age groups for available nouns?
```{r}
ranked <- tagged %>%
  ungroup() %>%
  mutate(age_quant = ntile(tagged$session,4)) %>%
  anti_join(stop_words) %>%
  filter(stem != "") %>%
  filter(grepl("n:",PoS, fixed=TRUE) | 
           grepl("n|",PoS, fixed=TRUE) |
           grepl("n",PoS, fixed=TRUE)) %>%
  group_by(stem, age_quant) %>%
  summarize(n=n()) %>% 
  arrange(age_quant, desc(n)) %>%
  group_by(age_quant) %>%
  mutate(rank = row_number())

ranked_wide <- ranked %>% 
  select(stem, age_quant, rank) %>% 
  spread(age_quant, rank) %>%
  rowwise() %>%
  mutate(tot_usage = sum(`1`, `2`, `3`, `4`, na.rm=TRUE)) %>%
  mutate(all_sess = if_else(is.na(`1` + `2` + `3` + `4`), F, T))

#filtered to things only in all sessions
ranked_all_sess <- ranked_wide %>% filter(all_sess==T)

cor.test(ranked_wide$`1`, ranked_wide$`2`, na.rm=TRUE)
cor.test(ranked_wide$`1`, ranked_wide$`4`, na.rm=TRUE)

```
###quick descriptives:
- 9,174 distinct nouns used across LDP (probably some data cleaning to do...)

- seperate 12 sessions into 4 bins, 1 year... ?
- 2,153 distinct nouns, after filtering only to things in all 4 years of measurment?
- 0.68 correlation of noun freq rank between time 1 and time 2, for all nouns
  - 0.59 correlation of noun freq rank between time 1 and time 4, for all nouns


#grab adjectives from target nouns
```{r}
#ranked_all_sess
#only nouns used in each year starting at session 1 (i.e. sessions [1:3, 4:6, 7:9, 10:12])
target_nouns <- ranked_all_sess %>% pull(stem)


#grab target utterances with target nouns
total_utts <- tagged
target_utts <- total_utts[total_utts$stem %in% target_nouns,] %>% 
  filter(PoS== "n") %>%
  rename(noun=word,
         noun_PoS = PoS) %>% 
  select(-stem)


adj_list <- total_utts %>% 
  filter(grepl("adj", PoS)) %>%
  filter(PoS == "adj") %>%
  distinct(PoS) %>% 
  pull(PoS)

all_adjectives <- total_utts[total_utts$PoS %in% adj_list,] %>% 
  rename(adj=word,
         adj_PoS = PoS) %>% 
  select(-stem)

#all the target utts with an ajective
adj_noun_utts <- inner_join(target_utts, all_adjectives, by=c("subject", "session", "p_chat", "p_mor", "utt_id"))
 # %>% filter(adj=="")

unmod_utts <- anti_join(target_utts, adj_noun_utts, by=c("subject", "session", "p_chat", "p_mor", "utt_id")) 

#should be 0
nrow(target_utts) - nrow(adj_noun_utts) - nrow(anti_utts)

target_utts %>% mutate(rowid_to_column())

#peek at most common pairs
adj_noun_utts %>% 
  count(adj, noun, sort=TRUE) %>%
  head(50)

#ALL pairs
adj_noun_pairs_target_full <- adj_noun_utts %>% 
  count(adj, noun, sort=TRUE) %>%
  mutate(rank = row_number()) 

#ALL pairs, split by session
adj_noun_pairs_target_session <- adj_noun_utts %>% 
  count(adj, noun, session) %>%
  arrange(session, desc(n), adj, noun)

#a ton of these pairs occur just once
adj_noun_pairs_target_full %>% filter(n==1) %>%
  group_by(adj, noun) %>% nrow
```

#Use Brysbaert threshold
```{r}
#get brysbaert concreteness
concrete_concepts <- read.csv("data/concreteness.csv") %>%
  mutate(stem= wordStem(Word)) %>%
  # filter(stem %in% target_nouns) %>%
  select(Word, stem, Conc.M, Conc.SD)

#get sense of concretness range across all 40,000 items
hist(concrete_concepts$Conc.M)

most_concrete <- concrete_concepts %>%
  mutate(conc_rank = ntile(Conc.M,4)) %>%
  arrange(desc(Conc.M)) %>%
  filter(conc_rank == 4)
#using 4 bins thresholds concreteness scores of 3.89 or higher...

#filter to concrete adjective + noun
adj_noun_concrete <- adj_noun_utts %>%
  mutate(adj_stem = wordStem(adj),
         noun_stem = wordStem(noun)) %>%
  filter(adj %in% most_concrete$Word &
         noun_stem %in% most_concrete$stem) %>%
  distinct()


adj_noun_concrete %>% 
  count(adj) %>%
  arrange(desc(n))

adj_noun_concrete %>% 
  count(noun)  %>%
  arrange(desc(n)) 


```


```{r}
#read in the judgment data
full_turk_counts <- read.csv("data/judgments_session.csv")
final_adjs <- full_turk_counts %>% distinct(adj) %>% pull(adj)
final_nouns <- full_turk_counts %>% distinct(noun) %>% pull(noun)
```
  

#session usage plot by typicality judgments
```{r}
#take session level usage
#  plot overall frequencies at each session
full_turk_counts_plot <- full_turk_counts
full_turk_counts_plot$session2 <- cut(full_turk_counts_plot$session, 
                   breaks=c(0, 2, 4, 6, 8, 10, 12),
                   labels = c(14, 22, 30, 38, 42, 50))
                   # breaks=c(0, 3, 6, 9, 12, 10, 12))

full_expanded <- full_turk_counts[rep(row.names(full_turk_counts), full_turk_counts$n), 1:17]

full_expanded %>%
  mutate(typicality=mean_typ) %>%
  mutate(age = (4*session + 10)) %>%
  filter(age <= 38) %>%
  group_by(session) %>%
  mutate(age=min(age)) %>% 
  ggplot( aes(x=as.numeric(typicality), y=age, group=age, fill=age)) +
  geom_density_ridges2() +
  ylab("Child Age (months)") +
  xlab("More Atypical                                                    More Typical \n   Typicality of adjective-noun pairs") +
  ggtitle("Density plot of parents' adjective use across development") +
  # geom_mark_rect(aes(filter= typicality >= 6, y=15.5)) +
  # geom_mark_rect(aes(filter= typicality >= 6, y=60)) +
  theme_minimal() +
  scale_fill_gradient(low="cornsilk", high=("red")) +
  theme(panel.grid = element_line(color="lightgrey",size=0.5),
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(),
    axis.text = element_text(size=20),
    axis.text.x = element_text(angle=30, hjust=1)) +
  # scale_x_continuous(minor_breaks = seq(1 , 7, 1), breaks = seq(1, 7, 1))+
  scale_x_continuous(minor_breaks = seq(1 , 7, 1), breaks = seq(1, 7, 1), labels = c('never', 'rarely', 'sometimes', 'about half', 'often', 'almost always', 'always')) +
  scale_y_continuous(minor_breaks = seq(14, 42, 4), breaks = seq(14, 38, 4))
  

```


#session prototypicals plot by typicality judgments
```{r}
#look for prototypicals
#  defined as anything 5 or higher, "somewhat typical" to "extremely  typical"
prototypicals <- full_expanded %>% 
  mutate(typicality=mean_typ) %>%
  group_by(session, typicality) %>%
  summarize(sum=n()) %>%
  mutate(howTyp = if_else(typicality>=5, T, F)) %>%
  group_by(session, howTyp) %>%
  summarize(sum=sum(sum)) %>%
  mutate(prop=sum/sum(sum)) %>%
  filter(howTyp)


prototypicals %>%
  mutate(age = (4*session + 10)) %>%
  ggplot(aes(x=age,y=prop, colour=age)) +
  geom_smooth(method= loess, color= "black")+
  geom_point(aes(fill=age), colour="black",pch=21, size=5) +
  ylab("Proportion of modifiers that rated as \n typical of modified noun") +
  xlab("Child's Age (months)") +
  scale_x_continuous(minor_breaks = seq(14, 58, 4), breaks = seq(14, 58, 4))+
  theme_minimal() +
  scale_fill_gradient(low="cornsilk", high=muted("red")) +
  theme(axis.line = element_line(colour = "black"),
        axis.ticks = element_line(),
        axis.text = element_text(size=20),
        panel.grid = element_line(color="lightgrey",size=0.5))




```

```{r}
booted <- full_expanded %>%
  mutate(typicality = mean_typ) %>%
  mutate(age = (4*session + 10)) %>%
  group_by(age) %>%
  tidyboot_mean(typicality)

booted %>%
  ggplot(aes(x=age, y=empirical_stat))+
  geom_bar(stat='identity') +
  geom_linerange(aes(ymin=ci_lower, ymax=ci_upper)) +
  geom_smooth(method=lm) +
  coord_cartesian(ylim=c(2.6,3.6))
```


#aoas
```{r}
aoas <- read_csv('data/aoas.csv')

full_aoas <- full_expanded %>%
  left_join(aoas, by=c("noun" = "word")) %>%
  mutate(typicality = mean_typ) %>%
  mutate(age = (4 * session + 10)) %>%
  mutate(acquired = if_else(predicted <= age, T, F)) %>%
  filter(! is.na(acquired)) %>%
  as_tibble()
```


```{r predicting-typicality}
freqs <- read_csv(here("data/full_freq.csv"))

tidy_aoas <- freqs %>%
  select(predicted, age, adj, noun, x1:x5, word_freq, mod_freq, prop_mod) %>%
  pivot_longer(cols = x1:x5, names_to = "rater", values_to = "score") %>%
  filter(!is.na(score))

lmer(score ~ log(age) + log(predicted) + scale(log(word_freq)) +
       (1|noun) + (1|adj), tidy_aoas) %>%
  summary()

glmer(cbind(mod_freq, word_freq - mod_freq) ~ log(predicted) + score +
       (1|noun) + (1|adj), family = "binomial", tidy_aoas) %>%
  summary()
```

```{r}
#problem- small range? can't really do the 'acquired' thing
range(full_aoas$predicted)


full_aoas$aoa_bin <- cut(full_aoas$predicted, 
                   # breaks=c(18, 20, 22, 24, 26, 28, 30, 34))
                   breaks=c(18, 22, 26, 30, 34))

full_aoas %>%
  group_by(predicted) %>%
  summarize(typicality = mean(typicality)) %>%
  ggplot(aes(x=(predicted), y= (typicality))) +
  geom_point() +
  geom_smooth(method=lm)


full_aoas %>%
  mutate(early = if_else(predicted < median(full_aoas$predicted), T, F)) %>%
  filter(age <= 34) %>%
  ggplot(aes(x=as.numeric(typicality), y=age, group=age, fill=age)) +
  geom_density_ridges2() +
  facet_grid(.~early)

```




#overall word freq
```{r}
# need to know overall word frequency to normalize or do conditional probability
word_freq <- total_utts %>%
  count(stem, sort=TRUE) %>%
  rename(word_freq = n)

modified_freq <- adj_noun_utts %>%
  count(noun, sort=TRUE) %>%
  rename(mod_freq = n)

full_freq <- full_aoas %>%
  left_join(word_freq, by=c("noun_stem" = "stem")) %>%
  left_join(modified_freq, by=c("noun" = "noun")) %>%
  mutate(prop_mod = mod_freq/word_freq)

full_freq %>% 
  group_by(predicted, age) %>%
  summarize(mean = mean(prop_mod)) %>%
  ggplot(aes(x=predicted, y=mean, group=age))+geom_point() + facet_wrap(~age)+
  geom_smooth(method=lm)
```



#get utt level
```{r}
final_utts <- adj_noun_utts %>% 
  filter(noun %in% final_nouns & adj %in% final_adjs)

full_turk_counts %>% summarize(sum(n))

final_utts <- 
  final_utts %>% left_join(full_turk_counts) %>% filter(!is.na(mean_typ))
```




tag the true prenominals?
```{r}
adj_noun_concrete_utts <- adj_noun_utts %>%
  mutate(adj_stem = wordStem(adj),
         noun_stem = wordStem(noun)) %>%
  filter(adj %in% most_concrete$Word &
         noun_stem %in% most_concrete$stem) 

tmp <- tagged %>%
  inner_join(adj_noun_concrete_utts, by=c("p_chat", "utt_id"))

prenominals <- tmp %>%
  group_by(p_chat) %>%
  mutate(lag_word = lag(word)) %>%
  filter(noun == word) %>%
  mutate(prenominal = if_else(lag_word == adj, T, F)) %>%
  distinct(utt_id, noun, adj, .keep_all = TRUE) 

prenominals %>%
  ungroup() %>%
  count(prenominal) %>%
  mutate(prop = n/sum(n))

prenominals %>% 
  filter(prenominal) %>%
  inner_join(full_turk_counts %>% select(adj, noun, mean_typ))  %>%
  distinct()
  
    mutate(age = (4*session + 10)) %>%
  filter(age <= 38) %>%
  group_by(session) %>%
  mutate(age=min(age)) %>%
  ggplot( aes(x=as.numeric(typicality), y=age, group=age, fill=age)) +
  geom_density_ridges2() +
  ylab("Child Age (months)") +
  xlab("More Atypical                                                    More Typical \n   Typicality of adjective-noun pairs") +
  ggtitle("Density plot of parents' adjective use across development") +
  # geom_mark_rect(aes(filter= typicality >= 6, y=15.5)) +
  # geom_mark_rect(aes(filter= typicality >= 6, y=60)) +
  theme_minimal() +
  scale_fill_gradient(low="cornsilk", high=("red")) +
  theme(panel.grid = element_line(color="lightgrey",size=0.5),
    axis.line = element_line(colour = "black"),
    axis.ticks = element_line(),
    axis.text = element_text(size=20),
    axis.text.x = element_text(angle=30, hjust=1)) +
  # scale_x_continuous(minor_breaks = seq(1 , 7, 1), breaks = seq(1, 7, 1))+
  scale_x_continuous(minor_breaks = seq(1 , 7, 1), breaks = seq(1, 7, 1), labels = c('never', 'rarely', 'sometimes', 'about half', 'often', 'almost always', 'always')) +
  scale_y_continuous(minor_breaks = seq(14, 42, 4), breaks = seq(14, 38, 4))
```






