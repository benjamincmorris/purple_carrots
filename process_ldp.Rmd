---
title: "Process LDP to text"
author: "Dan Yurovsky"
date: '`r Sys.Date()`'
output:
  html_document:
  highlight: tango
theme: sandstone
code_folding: show
toc: false
toc_float: false
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, library, message=F, results='hide', warning=FALSE}
library(here)
library(tidyverse)
library(tidytext)
library(glue)
library(udpipe)
```

```{r}
source(here("read_ldp.R"))
```


Load utterances
```{r load-ldp-data}
ldp <- connect_to_ldp()

subs_to_keep <- get_table(ldp, "subjects") %>%
    collect() %>%
    filter(lesion == "", project == 2) %>%
    pull(id)

utts <- get_table(ldp, "utterances") %>%
  select(time, row, subject, session, p_chat, c_chat) %>%
  collect() %>%
  filter(subject %in% subs_to_keep) %>%
  gather(person, utterance, p_chat, c_chat) %>%
  filter(!is.na(utterance)) %>%
  arrange(subject, session, row)

```

```{r, write-files}
write_file <- function(utterances, speaker = "parent") {
  speaker_tag <- if_else(speaker == "child", "c_chat", "p_chat") 
  
  utterances %>%
    filter(person == speaker_tag) %>%
    select(subject, session, row, utterance) %>%
    unnest_tokens(word, utterance) %>%
    group_by(subject, session, row) %>%
    summarise(utterance = paste0(word, collapse = " ")) %>%
    pull(utterance) %>%
    write_lines(here(glue("data/ldp_{speaker}.txt")))
}

walk(c("parent", "child"), ~write_file(utts, .x))

```

```{r, include = F, eval = F}
el <- udpipe_download_model(language = "english")
udmodel <- udpipe_load_model(file = el$file_model)

adult <- read_lines(here("data/ldp_parent.txt")) %>%
  enframe(name = NULL, value = "utterance") %>%
  mutate(annotation = udpipe_annotate(udmodel, utterance))

```
